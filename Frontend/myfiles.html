<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Files</title>
</head>
<body>
<h1>My Files</h1>
<div>
  <a href="upload.html">Upload</a> | 
  <a href="downloads.html">Downloads</a> | 
  <a id="logout">Logout</a>
</div>
<div id="fileList"></div>

<script>
const API_BASE = 'http://localhost:4000/api';
const token = localStorage.getItem('token');
if (!token) location.href = 'login.html';

document.getElementById('logout').addEventListener('click', () => {
  localStorage.clear();
  location.href = 'login.html';
});

async function loadFiles() {
  const res = await fetch(API_BASE + '/my-files', { headers: { 'Authorization': 'Bearer ' + token } });
  const json = await res.json();
  const container = document.getElementById('fileList');
  container.innerHTML = '';
  if (!json.files.length) return container.innerText = 'No files uploaded yet';
  
  json.files.forEach(f => {
    const div = document.createElement('div');
    div.innerHTML = `
      <strong>${f.originalname}</strong> (${Math.round(f.size/1024)} KB) - ${f.privacy}
      <button data-id="${f._id}" class="download">Download</button>
      <button data-id="${f._id}" class="delete">Delete</button>
    `;
    container.appendChild(div);
  });

  document.querySelectorAll('.download').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.id;
      window.open(API_BASE + '/files/' + id + '/download', '_blank');
    });
  });

  document.querySelectorAll('.delete').forEach(btn => {
    btn.addEventListener('click', async () => {
      if (!confirm('Delete this file?')) return;
      const id = btn.dataset.id;
      const res = await fetch(API_BASE + '/files/' + id, {
        method: 'DELETE',
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const json = await res.json();
      alert(json.error || json.message);
      loadFiles();
    });
  });
}

loadFiles();
</script>
</body>
</html>
